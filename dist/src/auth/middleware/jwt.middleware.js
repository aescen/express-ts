"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const jsonwebtoken_1=__importDefault(require("jsonwebtoken")),crypto_1=__importDefault(require("crypto")),users_service_1=__importDefault(require("../../users/services/users.service")),jwtSecret=process.env.JWT_SECRET;class JwtMiddleware{verifyRefreshBodyField(e,r,t){return e.body&&e.body.refreshToken?t():r.status(400).send({errors:["Missing required field: refreshToken"]})}async validRefreshNeeded(e,r,t){const s=await users_service_1.default.readByEmailWithPassword(r.locals.jwt.email),a=`${r.locals.jwt.userId}${jwtSecret}`,i=crypto_1.default.createSecretKey(Buffer.from(r.locals.jwt.refreshKey.data));return crypto_1.default.createHmac("sha512",i).update(a).digest("base64")===e.body.refreshToken?(e.body={id:s._id,email:s.email,permissionFlag:s.permissionFlag},t()):r.status(400).send({errors:["Invalid refresh token"]})}validJwtNeeded(e,r,t){if(!e.headers.authorization)return r.status(401).send();const s=e.headers.authorization.split(" ");if("Bearer"!==s[0])return r.status(401).send();try{r.locals.jwt=jsonwebtoken_1.default.verify(s[1],jwtSecret)}catch(e){return r.status(403).send()}return t()}}exports.default=new JwtMiddleware;